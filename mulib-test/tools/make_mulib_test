# Part of the mulib unit tests:
#  Compile the mulib-test source files into the build directory

.PHONY: all clean

MULIB_DIR = ../../mulib
#MULIB_PLATFORM_DIR = ../platform
MULIB_PLATFORM_DIR = ../../examples/POSIX/POSIX/mu_platform/

MULIB_TEST_DIR = ../test
MULIB_TEST_CORE_DIR = $(MULIB_TEST_DIR)/core
MULIB_TEST_EXTRAS_DIR = $(MULIB_TEST_DIR)/extras
#MULIB_TEST_PLATFORM_DIR = $(MULIB_TEST_DIR)/platform
MULIB_TEST_PLATFORM_DIR = ../../examples/POSIX/POSIX/mu_platform/

# NB: We allow test object files to co-mingle with mulib object files in the
# same directories.
BUILD_DIR = ../build
BUILD_CORE_DIR = $(BUILD_DIR)/core
BUILD_EXTRAS_DIR = $(BUILD_DIR)/extras
BUILD_PLATFORM_DIR = $(BUILD_DIR)/platform

MULIB_TEST_CORE_SOURCES := $(wildcard $(MULIB_TEST_CORE_DIR)/*.c)
MULIB_TEST_EXTRAS_SOURCES := $(wildcard $(MULIB_TEST_EXTRAS_DIR)/*.c)
MULIB_TEST_PLATFORM_SOURCES := $(wildcard $(MULIB_TEST_PLATFORM_DIR)/*.c)
MULIB_TEST_SOURCES := $(wildcard $(MULIB_TEST_DIR)/*.c)
# $(info    MULIB_TEST_CORE_SOURCES is $(MULIB_TEST_CORE_SOURCES))
# $(info    MULIB_TEST_EXTRAS_SOURCES is $(MULIB_TEST_EXTRAS_SOURCES))
# $(info    MULIB_TEST_PLATFORM_SOURCES is $(MULIB_TEST_PLATFORM_SOURCES))
# $(info    MULIB_TEST_SOURCES is $(MULIB_TEST_SOURCES))

MULIB_PLATFORM_INCLUDES := $(wildcard $(MULIB_PLATFORM_DIR)/*.h)
MULIB_TEST_INCLUDES := $(wildcard $(MLIB_TEST_DIR)/*.h)
# $(info    MULIB_TEST_INCLUDES is $(MULIB_TEST_INCLUDES))

MULIB_TEST_CORE_OBJECTS := $(patsubst $(MULIB_TEST_CORE_DIR)/%.c, $(BUILD_CORE_DIR)/%.o, $(MULIB_TEST_CORE_SOURCES))
MULIB_TEST_EXTRAS_OBJECTS := $(patsubst $(MULIB_TEST_EXTRAS_DIR)/%.c, $(BUILD_EXTRAS_DIR)/%.o, $(MULIB_TEST_EXTRAS_SOURCES))
MULIB_TEST_PLATFORM_OBJECTS := $(patsubst $(MULIB_TEST_PLATFORM_DIR)/%.c, $(BUILD_PLATFORM_DIR)/%.o, $(MULIB_TEST_PLATFORM_SOURCES))
MULIB_TEST_OBJECTS := $(patsubst $(MULIB_TEST_DIR)/%.c, $(BUILD_DIR)/%.o, $(MULIB_TEST_SOURCES))
# $(info    MULIB_TEST_CORE_OBJECTS is $(MULIB_TEST_CORE_OBJECTS))
# $(info    MULIB_TEST_EXTRAS_OBJECTS is $(MULIB_TEST_EXTRAS_OBJECTS))
# $(info    MULIB_TEST_PLATFORM_OBJECTS is $(MULIB_TEST_PLATFORM_OBJECTS))
# $(info    MULIB_TEST_OBJECTS is $(MULIB_TEST_OBJECTS))

CFLAGS = -Wall -Werror -g -DMU_LOG_ENABLED

IFLAGS = -I$(MULIB_TEST_DIR) -I $(MULIB_DIR) -I $(MULIB_PLATFORM_DIR) -I $(MULIB_EXTRAS_DIR)

all : $(MULIB_TEST_OBJECTS) $(MULIB_TEST_CORE_OBJECTS) $(MULIB_TEST_EXTRAS_OBJECTS) $(MULIB_TEST_PLATFORM_OBJECTS)


clean :
	rm -rf $(BUILD_DIR)

$(BUILD_TEST_CORE_DIR)/%.o : $(MULIB_TEST_CORE_DIR)/%.c $(MULIB_TEST_INCLUDES) $(MULIB_PLATFORM_INCLUDES)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(IFLAGS) -c $(<) -o $@

$(BUILD_TEST_EXTRAS_DIR)/%.o : $(MULIB_TEST_EXTRAS_DIR)/%.c $(MULIB_TEST_INCLUDES) $(MULIB_PLATFORM_INCLUDES)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(IFLAGS) -c $(<) -o $@

$(BUILD_TEST_PLATFORM_DIR)/%.o : $(MULIB_TEST_PLATFORM_DIR)/%.c $(MULIB_TEST_INCLUDES) $(MULIB_PLATFORM_INCLUDES)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(IFLAGS) -c $(<) -o $@

$(BUILD_DIR)/%.o : $(MULIB_TEST_DIR)/%.c $(MULIB_TEST_INCLUDES) $(MULIB_PLATFORM_INCLUDES)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(IFLAGS) -c $(<) -o $@
